generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserStatus {
  active
  disabled
}

enum SiteStatus {
  active
  inactive
}

enum SiteUserRole {
  owner
  admin
  viewer
}

enum DeviceStatus {
  online
  offline
  maintenance
}

enum SensorType {
  gas
  smoke
  flame
  motion
  door
  temp
  other
}

enum SensorStatus {
  ok
  faulty
  disabled
}

enum ReadingQualityFlag {
  ok
  suspect
}

enum EventType {
  gas
  smoke
  flame
  intrusion
  device_offline
  tamper
  other
}

enum Severity {
  low
  medium
  high
  critical
}

enum EventStatus {
  new
  acknowledged
  resolved
  false_alarm
}

enum AlertChannel {
  web_push
  email
  sms
}

enum AlertStatus {
  queued
  sent
  delivered
  failed
}

enum AuditActionType {
  create_event
  ack
  resolve
  login
  update_settings
  other
}

enum AuditTargetType {
  site
  device
  sensor
  event
  subscription
  other
}

model User {
  user_id       String     @id @default(uuid()) @db.Uuid
  full_name     String
  email         String     @unique
  phone         String?
  password_hash String
  status        UserStatus @default(active)
  last_login_at DateTime?  @db.Timestamptz(6)
  created_at    DateTime   @default(now()) @db.Timestamptz(6)

  site_users          SiteUser[]
  alert_notifications AlertNotification[] @relation("AlertRecipient")
  push_subscriptions  PushSubscription[]
  audit_logs          AuditLog[]

  @@index([status])
  @@map("User")
}

model Site {
  site_id      String     @id @default(uuid()) @db.Uuid
  name         String
  address_line String?
  city         String?
  country      String?
  status       SiteStatus @default(active)
  created_at   DateTime   @default(now()) @db.Timestamptz(6)

  site_users       SiteUser[]
  devices          Device[]
  emergency_events EmergencyEvent[]

  @@index([status])
  @@map("Site")
}

model SiteUser {
  site_id    String       @db.Uuid
  user_id    String       @db.Uuid
  role       SiteUserRole @default(viewer)
  created_at DateTime     @default(now()) @db.Timestamptz(6)

  site Site @relation(fields: [site_id], references: [site_id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@id([site_id, user_id])
  @@index([user_id])
  @@map("SiteUser")
}

model Device {
  device_id     String       @id @default(uuid()) @db.Uuid
  site_id       String       @db.Uuid
  serial_number String       @unique
  device_type   String
  secret_hash   String
  installed_at  DateTime?    @db.Timestamptz(6)
  last_seen_at  DateTime?    @db.Timestamptz(6)
  status        DeviceStatus @default(offline)
  created_at    DateTime     @default(now()) @db.Timestamptz(6)

  site             Site             @relation(fields: [site_id], references: [site_id], onDelete: Cascade)
  sensors          Sensor[]
  emergency_events EmergencyEvent[] @relation("EventDevice")

  @@index([site_id])
  @@index([status])
  @@index([last_seen_at])
  @@map("Device")
}

model Sensor {
  sensor_id      String       @id @default(uuid()) @db.Uuid
  device_id      String       @db.Uuid
  sensor_type    SensorType
  location_label String?
  is_enabled     Boolean      @default(true)
  status         SensorStatus @default(ok)
  installed_at   DateTime?    @db.Timestamptz(6)

  device           Device           @relation(fields: [device_id], references: [device_id], onDelete: Cascade)
  readings         SensorReading[]
  emergency_events EmergencyEvent[] @relation("EventSensor")

  @@index([device_id])
  @@index([sensor_type])
  @@index([status])
  @@map("Sensor")
}

model SensorReading {
  reading_id   String             @id @default(uuid()) @db.Uuid
  sensor_id    String             @db.Uuid
  value        Decimal            @db.Decimal(18, 6)
  unit         String?
  recorded_at  DateTime?          @db.Timestamptz(6)
  received_at  DateTime           @default(now()) @db.Timestamptz(6)
  quality_flag ReadingQualityFlag @default(ok)
  event_id     String?            @db.Uuid

  sensor Sensor          @relation(fields: [sensor_id], references: [sensor_id], onDelete: Cascade)
  event  EmergencyEvent? @relation("EventReadings", fields: [event_id], references: [event_id], onDelete: SetNull)

  @@index([sensor_id, received_at])
  @@index([event_id])
  @@map("SensorReading")
}

model EmergencyEvent {
  event_id        String      @id @default(uuid()) @db.Uuid
  site_id         String      @db.Uuid
  device_id       String?     @db.Uuid
  sensor_id       String?     @db.Uuid
  event_type      EventType
  severity        Severity
  status          EventStatus @default(new)
  title           String?
  description     String?
  started_at      DateTime    @db.Timestamptz(6)
  acknowledged_at DateTime?   @db.Timestamptz(6)
  resolved_at     DateTime?   @db.Timestamptz(6)
  created_at      DateTime    @default(now()) @db.Timestamptz(6)

  site   Site    @relation(fields: [site_id], references: [site_id], onDelete: Cascade)
  device Device? @relation("EventDevice", fields: [device_id], references: [device_id], onDelete: SetNull)
  sensor Sensor? @relation("EventSensor", fields: [sensor_id], references: [sensor_id], onDelete: SetNull)

  alert_notifications AlertNotification[]
  audit_logs          AuditLog[]
  readings            SensorReading[]     @relation("EventReadings")

  @@index([site_id, started_at])
  @@index([device_id])
  @@index([sensor_id])
  @@index([status])
  @@index([severity])
  @@map("EmergencyEvent")
}

model AlertNotification {
  alert_id          String       @id @default(uuid()) @db.Uuid
  event_id          String       @db.Uuid
  recipient_user_id String       @db.Uuid
  channel           AlertChannel @default(web_push)
  status            AlertStatus  @default(queued)
  sent_at           DateTime?    @db.Timestamptz(6)
  delivered_at      DateTime?    @db.Timestamptz(6)
  error_message     String?
  created_at        DateTime     @default(now()) @db.Timestamptz(6)

  event     EmergencyEvent @relation(fields: [event_id], references: [event_id], onDelete: Cascade)
  recipient User           @relation("AlertRecipient", fields: [recipient_user_id], references: [user_id], onDelete: Cascade)

  @@index([event_id])
  @@index([recipient_user_id, status])
  @@map("AlertNotification")
}

model PushSubscription {
  subscription_id String    @id @default(uuid()) @db.Uuid
  user_id         String    @db.Uuid
  endpoint        String    @unique
  p256dh_key      String
  auth_key        String
  user_agent      String?
  device_label    String?
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  revoked_at      DateTime? @db.Timestamptz(6)

  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id, is_active])
  @@map("PushSubscription")
}

model AuditLog {
  log_id      String          @id @default(uuid()) @db.Uuid
  user_id     String?         @db.Uuid
  event_id    String?         @db.Uuid
  action_type AuditActionType
  target_type AuditTargetType
  target_id   String?
  details     Json?
  created_at  DateTime        @default(now()) @db.Timestamptz(6)

  user  User?           @relation(fields: [user_id], references: [user_id], onDelete: SetNull)
  event EmergencyEvent? @relation(fields: [event_id], references: [event_id], onDelete: SetNull)

  @@index([user_id, created_at])
  @@index([event_id, created_at])
  @@index([action_type])
  @@map("AuditLog")
}
